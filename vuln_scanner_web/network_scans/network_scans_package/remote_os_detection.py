from scapy.all import IP, TCP, sr1
import nmap

def scapy_os_detection(host):
    # Stuur een TCP SYN-pakket naar een algemeen open poort (bijvoorbeeld 80)
    packet = IP(dst=host)/TCP(dport=80, flags="S")
    response = sr1(packet, timeout=2, verbose=0)
    
    if response is None:
        return "Unable to detect OS"

    # Haal TTL en window size uit het antwoord
    ttl = response[IP].ttl
    window_size = response[TCP].window

    # Eenvoudige heuristiek om het OS te detecteren
    if ttl <= 64:
        if window_size == 5840:
            return "Linux (Kernel 2.4, 2.6)"
        elif 9000 <= window_size <= 65535:
            return "Linux (Kernel 3.x)"
    elif ttl <= 128:
        if window_size == 8192:
            return "Windows (XP or 7)"
        elif window_size == 16384:
            return "Windows NT"
        elif window_size == 65535:
            return "Windows (10, 2016)"
    elif ttl <= 255:
        if window_size == 4128:
            return "Cisco Router (IOS)"
        elif window_size == 5720:
            return "Google Linux Server"
        else:
            return "Unknown OS"
    
    return "Unknown OS"

def nmap_os_detection(ip_address):
    # Initialize Nmap PortScanner
    nm = nmap.PortScanner()

    try:
        # Scan the IP address for OS detection
        nm.scan(ip_address, arguments="-O")

        # Fetch the scan results
        scan_results = nm[ip_address]

        # Extract OS details if available
        if 'osclass' in scan_results:
            for osclass in scan_results['osclass']:
                os_family = osclass['osfamily'] if 'osfamily' in osclass else 'Unknown'
                os_gen = osclass['osgen'] if 'osgen' in osclass else 'Unknown'
                return f"Detected OS: {os_family} {os_gen}"
        else:
            return "OS detection not possible"

    except nmap.PortScannerError:
        return "Nmap Error: Make sure Nmap is installed and your input is correct"
    except Exception as e:
        return f"An error occurred: {str(e)}"

# # Testen van de functie
# host_ip = "192.168.0.166"  # Pas dit aan naar het IP-adres dat je wilt onderzoeken
# os_detected = nmap_os_detection(host_ip)
# print(f"Detected OS for {host_ip}: {os_detected}")
