from celery import shared_task
import requests
from django.conf import settings
import os
import logging

logger = logging.getLogger(__name__)

@shared_task
def check_and_clean_proxies():
    test_target = "http://www.whatsmyip.org/"
    proxy_file_path = os.path.join(settings.BASE_DIR, 'config', 'proxies.txt')
    logger.info("Starting proxy check task.")
    print("Starting proxy check task.")

    with open(proxy_file_path, "r") as file:
        proxies = file.read().splitlines()

    valid_proxies = []
    for proxy in proxies:
        if test_proxy(proxy, test_target):
            valid_proxies.append(proxy)
            logger.info(f"Valid proxy: {proxy}")
        else:
            logger.info(f"Invalid proxy: {proxy}")

    with open(proxy_file_path, "w") as file:
        file.write("\n".join(valid_proxies))
        
    logger.info("Finished checking proxies. Updating the file.")

def test_proxy(proxy, test_target):
    try:
        res = requests.get(test_target, proxies={"http": proxy, "https": proxy}, timeout=10)
        return res.status_code == 200
    except requests.RequestException:
        return False
