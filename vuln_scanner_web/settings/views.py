import os
from django.conf import settings
from django.shortcuts import render, redirect
from .forms import ProxyForm, WordlistUploadForm
from django.http import HttpResponseRedirect
from django.urls import reverse
from django.core.paginator import Paginator
# from utils.check_proxies import main as check_proxies_main
from django.contrib import messages
from .tasks import check_and_clean_proxies

# Create your views here.

def index(request):
    return render(request, 'settings/index.html', {'current_page': 'settings'})

def settings_view(request):
    success_message = ''
    wordlist_form = WordlistUploadForm(request.POST, request.FILES or None)
    proxy_form = ProxyForm(request.POST or None)

    if request.method == 'POST':
        if 'upload_wordlist' in request.POST and wordlist_form.is_valid():
            handle_uploaded_file(request.FILES['wordlist'])
            success_message = 'Wordlist successfully uploaded.'
            return redirect('settings')
        elif 'check_proxies' in request.POST:
            check_and_clean_proxies.delay()
            success_message = 'Proxy check complete.'
            messages.info(request, 'Checking proxies. This might take a while.')
            return redirect('settings')
            
    # Get the list of wordlist files
    wordlist_dir = os.path.join(settings.BASE_DIR, 'config', 'word_lists')
    wordlist_files = os.listdir(wordlist_dir)

    # Manage Proxies
    proxy_list = get_proxy_list()
    paginator = Paginator(proxy_list, 10)  # Show 10 proxies per page

    page_number = request.GET.get('page')
    page_obj = paginator.get_page(page_number)
    proxy_form = ProxyForm(request.POST or None)

    if request.method == 'POST':
        if 'add_proxy' in request.POST and proxy_form.is_valid():
            add_proxy_to_list(proxy_form.cleaned_data['proxy'])
            return redirect('settings')
        elif 'remove_proxy' in request.POST:
            remove_proxy_from_list(request.POST.get('remove_proxy'))
            return redirect('settings')

    context = {
        'form': wordlist_form,  # Existing form context
        'wordlist_files': wordlist_files,
        'proxy_list': proxy_list,
        'proxy_form': proxy_form,
        'page_obj': page_obj,  # pass the page object to the template
    }
    return render(request, 'settings/index.html', context)

    # return render(request, 'settings/index.html', {'form': form})

def handle_uploaded_file(f):
    wordlist_dir = os.path.join(settings.BASE_DIR, 'config/word_lists')
    os.makedirs(wordlist_dir, exist_ok=True)  # Create dir if doesn't exist
    with open(os.path.join(wordlist_dir, f.name), 'wb+') as destination:
        for chunk in f.chunks():
            destination.write(chunk)
            
def delete_wordlist(request):
    if request.method == 'POST':
        filename = request.POST.get('filename')
        file_path = os.path.join(settings.BASE_DIR, 'config', 'word_lists', filename)
        if os.path.exists(file_path):
            os.remove(file_path)
    return HttpResponseRedirect(reverse('settings'))  # Redirect back to the settings page

def get_proxy_list():
    proxy_file_path = os.path.join(settings.BASE_DIR, 'config', 'proxies.txt')
    with open(proxy_file_path, 'r') as file:
        return file.read().splitlines()

def add_proxy_to_list(proxy):
    proxy_file_path = os.path.join(settings.BASE_DIR, 'config', 'proxies.txt')
    with open(proxy_file_path, 'a') as file:
        file.write(f"\n{proxy}")

def remove_proxy_from_list(proxy):
    proxy_file_path = os.path.join(settings.BASE_DIR, 'config', 'proxies.txt')
    with open(proxy_file_path, 'r') as file:
        proxies = file.read().splitlines()
    proxies.remove(proxy)
    with open(proxy_file_path, 'w') as file:
        file.writelines("\n".join(proxies))