import threading
import queue
import requests

q = queue.Queue()
test_target = "http://www.whatsmyip.org/"

def check_proxy(proxy):
    try:
        res = requests.get(test_target, proxies={"http": proxy, "https": proxy}, timeout=10)
        if res.status_code == 200:
            return True
    except requests.RequestException:
        pass
    return False

def worker(valid_proxies_set):
    while not q.empty():
        proxy = q.get()
        if check_proxy(proxy):
            valid_proxies_set.add(proxy)
        q.task_done()

def main(test_target_site="http://www.whatsmyip.org/"):
    global test_target
    test_target = test_target_site
    valid_proxies_set = set()

    with open("config/proxies.txt", "r") as f:
        proxies_list = set(f.read().splitlines())  # Remove duplicates right from the start

    for p in proxies_list:
        q.put(p)

    threads = []
    for _ in range(10):
        t = threading.Thread(target=worker, args=(valid_proxies_set,))
        t.start()
        threads.append(t)

    for t in threads:
        t.join()

    # Rewrite proxies.txt with valid (and now unique) proxies
    with open("config/proxies.txt", "w") as f:
        for proxy in valid_proxies_set:
            f.write(f"{proxy}\n")

if __name__ == "__main__":
    main()
