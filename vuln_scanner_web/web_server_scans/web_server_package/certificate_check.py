import ssl
import socket
from datetime import *
import certifi
import json
from web_server_scans.web_server_package.icheck import ICheck

#To use this class, you create an instance with the domain/IP address as a property like this: scanner = CertChecker("google.com"). 
#Then, you can use the report method of the class to get the results in JSON format: scanner.report().
# The data looks like this, for example, for google.com
#{"target": "google.com", "issuer": [[["countryName", "US"]], [["organizationName", "Google Trust Services LLC"]], [["commonName", "GTS CA 1C3"]]], "subject": [[["commonName", "*.google.com"]]], "expiration date": "Nov 27 08:17:05 2023 GMT", "expired": false}


class CertChecker(ICheck):
    def __init__(self, domain):
        # Initialize the CertChecker
        super().__init__(domain)
        self.result = None
        self.output_log = None
        self.end_time = None
        self.scan()

    def scan(self) -> json:
        # Create an SSL context with certificate validation
        context = ssl.create_default_context(cafile=certifi.where())
            # Create a socket and wrap it with SSL
        with socket.create_connection((self.target, 443)) as sock:
            with context.wrap_socket(sock, server_hostname=self.target) as ssock:
                cert = ssock.getpeercert()
            
                # Extract certificate information
                issuer = cert['issuer']
                subject = cert['subject']
                expiration_date = datetime.strptime(cert['notAfter'], '%b %d %H:%M:%S %Y %Z')
            
            
                # Check if the certificate is expired
                if expiration_date < datetime.now():
                    expired = True
                else:
                    expired = False

                scan_results = {
                    "target": self.target,
                    "issuer": issuer,
                    "subject": subject,
                    "expiration_date": cert['notAfter'],
                    "expired": expired
                    }
                self.result = scan_results
            
    def report(self):
        # Generate a report with the results
        super().report()
        results = {
            "Timestamp": str(self.end_time),
            "Result": self.result
        }
        return json.dumps(results, indent=4)


# # Test usage:
# scanner = CertChecker("https://google.com")
# print(scanner.report())