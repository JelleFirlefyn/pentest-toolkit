import queue
import requests
from tqdm import tqdm
from utils import get
import random
import threading


def get_words(wordlist, file_extensions, resume=None):
    def extend_words(word, words):
        if "." in word:
            words.put(f'/{word}')
        else:
            words.put(f'/{word}/')

        for extension in file_extensions:
            words.put(f'/{word}{extension}')

    with open(wordlist) as f:
        raw_words = f.read()

    found_resume = False
    words = queue.Queue()
    for word in raw_words.split():
        if resume is not None:
            if found_resume:
                extend_words(word, words)
            elif word == resume:
                found_resume = True
                print(f'Resuming wordlist from: {resume}')
        else:
            extend_words(word, words)
    return words


def dir_bruter(target, words, agent, pbar, results):
    headers = {'User-Agent': agent}
    while not words.empty():
        url = f'{target}{words.get()}'
        try:
            r = requests.get(url, headers=headers)
            if r.status_code == 200:
                results.append(url)  # Add the successful URL to results
        except requests.exceptions.ConnectionError:
            continue
        finally:
            pbar.update(1)  # Update the progress bar

def main(target, wordlist, file_extensions, num_threads=10, resume=None):
    agent = random.choice(get.user_agents())
    words = get_words(wordlist, file_extensions, resume)
    results = []  # List to store results

    pbar = tqdm(total=words.qsize(), desc="Scanning", dynamic_ncols=True)

    threads = []
    for _ in range(num_threads):
        t = threading.Thread(target=dir_bruter, args=(target, words, agent, pbar, results))
        t.start()
        threads.append(t)

    for t in threads:
        t.join()

    return results  # Return the list of results

# Example usage
# if __name__ == "__main__":
#     target = "http://testphp.vulnweb.com"
#     wordlist = "config/word_lists/test.txt"
#     file_extensions = ['.php']

#     main(target, wordlist, file_extensions, num_threads=10)