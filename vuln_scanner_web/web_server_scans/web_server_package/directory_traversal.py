import queue
import requests
from tqdm import tqdm
from utils import get
import random


def get_words(wordlist, file_extensions, resume=None):
    def extend_words(word, words):
        if "." in word:
            words.put(f'/{word}')
        else:
            words.put(f'/{word}/')

        for extension in file_extensions:
            words.put(f'/{word}{extension}')

    with open(wordlist) as f:
        raw_words = f.read()

    found_resume = False
    words = queue.Queue()
    for word in raw_words.split():
        if resume is not None:
            if found_resume:
                extend_words(word, words)
            elif word == resume:
                found_resume = True
                print(f'Resuming wordlist from: {resume}')
        else:
            extend_words(word, words)
    return words


def dir_bruter(target, words, agent, pbar):
    headers = {'User-Agent': agent}
    while not words.empty():
        url = f'{target}{words.get()}'
        try:
            r = requests.get(url, headers=headers)
            if r.status_code == 200:
                print(f'\nSuccess ({r.status_code}: {url})')
            elif r.status_code != 404:
                print(f'{r.status_code} => {url}')
        except requests.exceptions.ConnectionError:
            continue
        finally:
            pbar.update(1)  # Update the progress bar


def main(target, wordlist, file_extensions, resume=None):
    agent = random.choice(get.user_agents())
    words = get_words(wordlist, file_extensions, resume)

    pbar = tqdm(total=words.qsize(), desc="Scanning",
                dynamic_ncols=True)  # Initialize tqdm progress bar

    dir_bruter(target, words, agent, pbar)


# Example usage
if __name__ == "__main__":
    target = "http://testphp.vulnweb.com"
    wordlist = "config/word_lists/test.txt"
    file_extensions = ['.php']

    main(target, wordlist, file_extensions)
